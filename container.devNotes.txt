
[[ -d /global/scratch/users/${USER}/cacheDir ]] && export cacheDir=/global/scratch/users/${USER}/cacheDir
[[ -d $cacheDir ]] && export SINGULARITY_CACHEDIR=$cacheDir
[[ -d $cacheDir ]] && export SINGULARITY_TMPDIR=$cacheDir
[[ -d $cacheDir ]] && export SINGULARITY_WORKDIR=$cacheDir

ImgDir=/global/home/groups/consultsw/sl-7.x86_64/modules/beast2/2.6.4
cd $ImgDir


# Make and CD to a ImgDir to store the container image
singularity pull --name beast2.6.4-beagle.sif  docker://ghcr.io/tin6150/beast2:dock264-beagle
singularity pull --name beast2.6.4-noOCL.sif   docker://ghcr.io/tin6150/beast2:dock264-noOCL

./beast2.6.4-beagle.sif -java       testHKY.xml   # 4s/Msamples
./beast2.6.4-beagle.sif -beagle_CPU testHKY.xml   # 2s/Msamples


# GPU need additional singularity flag, thus need to run as below, which get 28s/Msamples:
singularity exec --nv $ImgDir/beast2.6.4-beagle.sif /usr/bin/java -Dlauncher.wait.for.exit=true -Xms256m -Xmx8g -Duser.language=en -cp /opt/gitrepo/beast/lib/launcher.jar beast.app.beastapp.BeastLauncher -beagle_GPU testHKY.xml

# To ensure beagle see GPU on the machine, run this test:
singularity exec --nv $ImgDir/beast2.6.4-beagle.sif /usr/bin/java -Dlauncher.wait.for.exit=true -Xms256m -Xmx8g -Duser.language=en -cp /opt/gitrepo/beast/lib/launcher.jar beast.app.beastapp.BeastLauncher -beagle_info
